# תהליך ניהול הלקוחות

מסך זה מציג סטטיסטיקות ורשימת לקוחות ומאפשר צפייה מפורטת בפעילות של כל לקוח.

## תהליך טעינת הדף
1. `page.tsx` מפעיל `requireUserSession` ומוודא שלמשתמש יש תפקיד "admin".
2. העמוד מוגדר כדינמי ולכן הנתונים נטענים בכל ביקור.
3. הקומפוננטה `CustomersClient` נטענת ומבצעת קריאה ראשונה ל־`getAllCustomers` לקבלת הרשימה הראשונית.

## ניהול נתונים וסטטיסטיקות
- `getAllCustomers` מחפש במאגר המשתמשים לפי שם, מייל או טלפון ומחזיר גם ספירת עמודים כוללת.
- `getCustomerSummary` מאחד נתונים ממספר מודלים (הזמנות, מנויים, שוברים) ומחשב סך הוצאה, מספר הזמנות, מנויים פעילים ועוד.
- `getAllPurchaseTransactions` מחזיר עסקאות של הלקוח בהתאם למסננים ונעזר בפעולה המשותפת שב־`actions/purchase-summary-actions.ts`.

## ניהול רשימת הלקוחות
- בצד הלקוח נשמרים מצבי חיפוש, מיון, סוג משתמש נבחר ומספר עמוד נוכחי.
- שינוי אחד מהפרמטרים גורם לטעינה מחדש של הרשימה דרך `getAllCustomers`.
- הנתונים מוצגים בטבלה עם כפתור "צפה בפרטים" לכל לקוח.

## פעולות CRUD
המסך אינו מאפשר יצירה או מחיקה של לקוחות; כל הלקוחות נוצרים בתהליכי הרשמה אחרים. העמוד משמש רק לצפייה בנתונים וסטטיסטיקות.

## ולידציה ואימות
- כל פעולות השרת בודקות שהקריאה הגיעה ממשתמש בעל תפקיד "admin".
- מזהי לקוחות נבדקים באמצעות `Types.ObjectId.isValid` לפני גישה למסד הנתונים.

## ניהול מצב ומשוב
- `CustomersClient` משתמש ב־`useState` ו־`useEffect` לטעינת נתונים ולשמירת מצב המסכים.
- הודעות שגיאה מוצגות באמצעות `useToast` אם אחת מהפעולות מחזירה שגיאה.
- בעת טעינת עסקאות הלקוח מוצג סימן טעינה ומנוטרלים כפתורי הפאגינציה.
