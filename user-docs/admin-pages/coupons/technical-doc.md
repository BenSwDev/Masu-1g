# תהליך ניהול הקופונים

מסך הקופונים מאפשר למנהל ליצור ולעדכן קופונים במערכת. להלן התיאור הטכני המלא של התהליכים.

## תהליך טעינת הדף
1. בקשת הדף מפעילה את `requireUserSession` כדי לאמת שהמשתמש מחובר ובעל תפקיד מנהל.
2. מופעלות הפונקציות `getAdminCoupons` ו־`getPartnersForSelection` מתוך `actions.ts` לקבלת רשימת הקופונים והשותפים.
3. נתונים אלה מועברים כ־props לרכיב `CouponsClient` שמוצג בתוך `Suspense` עם שלד טעינה.

## ניהול נתונים וסטטיסטיקות
- `getAdminCoupons` מבצע חיבור למסד הנתונים דרך `dbConnect`, בונה שאילתה בהתאם לפרמטרים (`code`, `isActive`, `partnerId`) ומחזיר את רשימת הקופונים, מספר העמודים והסטטוס המחושב של כל קופון.
- `getPartnersForSelection` מביא רשימת משתמשים בעלי תפקיד "partner" להצגה ברשימת בחירה.
- המידע במודל `coupon.ts` כולל וירטואלים כגון `isCurrentlyValid` ו־`isUsageLimitReached` המסייעים בקביעת סטטוס הקופון.

## ניהול רשימת הקופונים
- בצד הלקוח נשמרים מצב הרשימה, העמוד הנוכחי וסך הקופונים ב־React state.
- הנתונים הראשוניים מתקבלים מהשרת בעת טעינת הדף, וכל שינוי (יצירה/עריכה/מחיקה) מעדכן את המצב ללא רענון מלא של הדף.
- ברזולוציה צרה מוצגים כרטיסים (`CouponCard`), וברזולוציה רחבה מוצגת טבלה באמצעות `DataTable` עם עמודות המוגדרות ב־`coupons-columns.tsx`.

## פעולות CRUD
- `createCoupon` ו־`updateCoupon` מופעלות מתוך הטופס ומבצעות ולידציה בשרת לפני שמירת הנתונים. לאחר הצלחה מוחזר האובייקט המלא כולל `effectiveStatus` המעודכן.
- `deleteCoupon` מקבלת מזהה קופון ומוחקת אותו מהמסד. לאחר כל פעולה נקרא `revalidatePath("/dashboard/admin/coupons")` כדי לרענן נתונים.

## ולידציה ואימות
- הטופס (`coupon-form.tsx`) משתמש ב־`zod` להגדרת סכמת שדות, כולל בדיקת תאריכים הגיוניים ומגבלות שימוש.
- מודל Mongoose מבצע בדיקות נוספות (לדוגמה, ייחוד קוד קופון ובדיקת טווח תאריכים) ומכיל hook המונע שמירת קופון עם `validUntil` מוקדם מ־`validFrom`.

## ניהול מצב ומשוב
- `CouponsClient` מציג דיאלוגי אישור לפני מחיקה וטפסי יצירה/עריכה בתוך `Dialog` של Shadcn.
- פונקציות השרת מחזירות אובייקט הכולל `success` ו־`error`. בצד הלקוח מוצגים Toasts מתורגמים בהתאם לתוצאה (הצלחה או כישלון).
- שלדי הטעינה (`CouponCardSkeleton`, `TableLoadingSkeleton`, `ClientAwareCouponsLoadingSkeleton`) מספקים חיווי בזמן הבאת נתונים או מעבר בין עמודים.
