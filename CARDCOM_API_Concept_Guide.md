# מדריך קונספטואלי - תקשורת CARDCOM API

## מה זה CARDCOM ואיך זה עובד?

CARDCOM הוא שירות עיבוד תשלומים שמאפשר לקבל תשלומים באשראי דרך האינטרנט. הוא עובד כמתווך בין האתר שלך לבין חברות האשראי.

## הזרימה הבסיסית של תשלום

### שלב 1: יצירת תשלום (Payment Creation)
**מה קורה:** האתר שלך יוצר "בקשת תשלום" ושולח אותה ל-CARDCOM
**מה שולחים:**
- סכום התשלום
- תיאור העסקה
- מספר הזמנה שלך (לזיהוי)
- כתובות להפניה (הצלחה/כישלון)
- בקשה ליצירת טוקן (לחיובים עתידיים)

**מה מקבלים בחזרה:**
- URL לדף התשלום של CARDCOM
- מזהה עסקה זמני
- סטטוס הבקשה

### שלב 2: הפניה ללקוח
**מה קורה:** הלקוח מועבר לדף התשלום של CARDCOM (לא שלך!)
**למה זה חשוב:** CARDCOM מטפל בכל פרטי האשראי - אתה אף פעם לא רואה או שומר מספרי כרטיסי אשראי

### שלב 3: עיבוד התשלום
**מה קורה:** הלקוח מזין פרטי אשראי בדף של CARDCOM
**CARDCOM עושה:**
- בדיקת תקינות הכרטיס
- אישור מחברת האשראי
- יצירת טוקן (אם ביקשת)
- חיוב הכרטיס

### שלב 4: החזרת תוצאות
**מה קורה:** CARDCOM מחזיר את הלקוח לאתר שלך עם התוצאות
**מה מקבלים:**
- סטטוס התשלום (הצליח/נכשל)
- מזהה עסקה סופי
- טוקן (אם התשלום הצליח)
- פרטים נוספים (4 ספרות אחרונות של הכרטיס, וכו')

## מה זה טוקן ולמה זה חשוב?

**טוקן** = מחרוזת מוצפנת שמייצגת את כרטיס האשראי של הלקוח
**למה זה שימושי:**
- אתה יכול לחייב את הלקוח שוב בעתיד בלי שהוא יזין שוב פרטי אשראי
- אתה לא שומר פרטי אשראי אמיתיים (בטוח יותר)
- מאפשר חיובים אוטומטיים, זיכויים, וכו'

## סוגי פעולות שאפשר לעשות

### 1. תשלום רגיל (Regular Payment)
- לקוח חדש משלם בפעם הראשונה
- מקבל טוקן בסוף התהליך

### 2. חיוב ישיר (Direct Charge)
- משתמש בטוקן קיים
- חיוב מיידי בלי שהלקוח צריך להזין שוב פרטים
- שימושי למנויים, תשלומים חוזרים, וכו'

### 3. זיכוי (Refund)
- החזרת כסף ללקוח
- משתמש בטוקן או במזהה עסקה מקורי
- הכסף חוזר לכרטיס האשראי של הלקוח

## מה צריך לשמור בבסיס הנתונים שלך?

### טבלת הזמנות (Orders)
- מזהה הזמנה שלך
- פרטי הלקוח (שם, אימייל, טלפון)
- סכום התשלום
- סטטוס ההזמנה
- נתוני כרטיס אשראי (רק 4 ספרות אחרונות + סוג כרטיס)

### טבלת תשלומים (Payments)
- מזהה התשלום שלך
- קישור להזמנה
- סוג הפעולה (תשלום/זיכוי)
- סכום
- זמן התחלה וסיום
- האם הפעולה הושלמה בהצלחה
- מזהה עסקה של CARDCOM
- הטוקן (אם קיים)
- כל הנתונים שחזרו מ-CARDCOM (JSON)

## איך מתקשרים עם CARDCOM?

### פרטי חיבור נדרשים
- **Terminal Number** - מספר הטרמינל שלך ב-CARDCOM
- **Username** - שם המשתמש
- **API Key** - מפתח API
- **Base URL** - כתובת השרת של CARDCOM

### סוגי בקשות HTTP
- **POST** לכל הפעולות
- **Content-Type: application/json**
- **HTTPS בלבד** (אבטחה)

### Endpoints עיקריים
- **LowProfile** - ליצירת תשלום חדש
- **Charge** - לחיוב ישיר עם טוקן

## מה שולחים בכל בקשה?

### בקשה ליצירת תשלום
- פרטי הטרמינל (Terminal, Username, API Key)
- סוג פעולה (1 = חיוב, 2 = זיכוי)
- מטבע (1 = שקל)
- סכום
- תיאור העסקה
- מזהה הזמנה שלך
- כתובות הפניה (הצלחה/כישלון)
- בקשה ליצירת טוקן (true/false)

### בקשה לחיוב ישיר
- אותם פרטי טרמינל
- הטוקן השמור
- סכום חדש
- תיאור חדש
- מזהה הזמנה

## איך מטפלים בתגובות?

### תגובה מוצלחת
- **ResponseCode = 0** = הכל בסדר
- מקבלים URL להפניה (לתשלום חדש) או מזהה עסקה (לחיוב ישיר)

### תגובה עם שגיאה
- **ResponseCode != 0** = יש בעיה
- מקבלים הודעת שגיאה בעברית
- צריך להציג ללקוח ולנסות שוב

## ניהול שגיאות וחריגים

### שגיאות רשת
- בעיות חיבור לאינטרנט
- timeout של הבקשה
- שרת CARDCOM לא זמין

### שגיאות עסקיות
- כרטיס אשראי לא תקין
- אין מספיק כסף בכרטיס
- כרטיס חסום
- פרטים שגויים

### איך להתמודד
- תמיד לשמור לוג של הבקשה והתגובה
- להציג הודעות ברורות ללקוח
- לאפשר ללקוח לנסות שוב
- לא לחשוף פרטים טכניים ללקוח

## אבטחה וחשיבות

### מה אסור לעשות
- **לעולם לא לשמור מספרי כרטיסי אשראי**
- לא לשלוח פרטי אשראי דרך GET parameters
- לא להציג טוקנים בלוגים או בממשק המשתמש

### מה חובה לעשות
- להשתמש ב-HTTPS בלבד
- לוולד את כל הקלטים מהמשתמש
- לשמור את פרטי החיבור ל-CARDCOM במקום בטוח
- לעשות backup לנתוני התשלומים

## זרימת עבודה מומלצת ב-Next.js

### API Routes שתצטרך
1. **POST /api/payments/create** - יצירת תשלום חדש
2. **POST /api/payments/callback** - קבלת תוצאות מ-CARDCOM
3. **POST /api/payments/charge** - חיוב ישיר עם טוקן
4. **POST /api/payments/refund** - זיכוי

### מה כל API Route עושה

#### /api/payments/create
- מקבל פרטי הזמנה מהלקוח
- יוצר רשומה בבסיס הנתונים
- שולח בקשה ל-CARDCOM
- מחזיר URL להפניה

#### /api/payments/callback
- מקבל תוצאות מ-CARDCOM
- מעדכן את בסיס הנתונים
- שולח אימייל ללקוח (אם הצליח)
- מפנה ללקוח לדף מתאים

#### /api/payments/charge
- מקבל בקשה לחיוב ישיר
- מוצא טוקן שמור
- שולח בקשה ל-CARDCOM
- מעדכן בסיס נתונים

#### /api/payments/refund
- מקבל בקשה לזיכוי
- מוצא את התשלום המקורי
- שולח בקשת זיכוי ל-CARDCOM
- מעדכן בסיס נתונים

## מה המפתח להצלחה?

### תכנון נכון
- לחשוב על כל התרחישים מראש
- לתכנן את מבנה בסיס הנתונים היטב
- לבנות מערכת לוגים טובה

### בדיקות יסודיות
- לבדוק עם כרטיסי בדיקה של CARDCOM
- לבדוק תרחישי כישלון
- לבדוק שהטוקנים נשמרים ועובדים

### ניטור מתמיד
- לעקוב אחר שיעור הצלחה של התשלומים
- לזהות בעיות מהר
- לשפר את חוויית המשתמש

---

**הנקודה החשובה ביותר:** CARDCOM מטפל בכל החלק המורכב והמסוכן (פרטי אשראי), אתה רק מתקשר איתם דרך API פשוט ומקבל תוצאות. זה הופך את התהליך לבטוח ופשוט יחסית. 