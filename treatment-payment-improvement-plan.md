# תוכנית עבודה: שיפור מערכת תשלום למטפלים

## 1. מצב קיים במערכת

### מבנה נתונים קיים
- **מודל Treatment**: כולל `fixedProfessionalPrice` (טיפולים קבועים) ו-`professionalPrice` בכל `duration` (טיפולים משתנים)
- **מודל ProfessionalProfile**: כולל מערך `treatments: ITreatmentPricing[]` שמאפשר מחירים מותאמים למטפל
- **מודל Booking**: כולל `staticTherapistPay` שמקבע את התשלום למטפל בהזמנה

### לוגיקה נוכחית 
- ב-`actions/booking-actions.ts` (שורות 2550-2580, 2740-2780): המערכת תמיד מגדירה את `staticTherapistPay` לפי מחירי הבסיס של הטיפול
- לא מתחשבת במחירים המותאמים המוגדרים ב-`ITreatmentPricing` של המטפל
- המחיר נקבע פעם אחת בעת יצירת ההזמנה ולא מתעדכן כשמשייכים מטפל

### ממשקי משתמש קיימים
- **מנהל**: `app/dashboard/(user)/(roles)/admin/professional-management/` - ניהול מחירי מטפלים
- **מטפל**: `app/dashboard/(user)/(roles)/professional/financial/` - צפייה בסיכום פיננסי
- **הזמנות**: `app/dashboard/(user)/(roles)/admin/bookings/` - ניהול הזמנות

## 2. שינויים נדרשים לדברים קיימים

### 2.1 עדכון לוגיקת חישוב מחיר במטפל
**קובץ**: `actions/booking-actions.ts`

**מיקום**: פונקציות שמגדירות `staticTherapistPay` (שורות ~2558, ~2751)

**שינוי נדרש**: 
1. לפני שימוש במחיר הבסיס של הטיפול, לבדוק אם יש מטפל משוייך להזמנה
2. אם יש מטפל משוייך, לחפש ב-`ProfessionalProfile.treatments` מחיר מותאם
3. אם נמצא מחיר מותאם - להשתמש בו
4. אם לא נמצא מחיר מותאם - להשתמש במחיר הבסיס של הטיפול

### 2.2 עדכון לוגיקת שיוך מטפל להזמנה
**קובץ**: `actions/booking-actions.ts`

**מיקום**: פונקציה `assignProfessionalToBooking` (שורה ~2271)

**שינוי נדרש**:
1. לאחר שיוך המטפל, לעדכן את `staticTherapistPay` לפי המחיר המותאם למטפל (אם קיים)
2. לעדכן את `companyFee` בהתאם
3. לוודא שהעדכון נשמר בבסיס הנתונים

### 2.3 עדכון ממשק ניהול הזמנות למנהל
**קובץ**: `app/dashboard/(user)/(roles)/admin/bookings/[bookingId]/page.tsx`

**שינוי נדרש**:
1. להוסיף שדה עריכה של `staticTherapistPay` בממשק
2. לוודא שהשדה זמין לעריכה גם כשיש מטפל משוייך וגם כשאין
3. לעדכן את `companyFee` אוטומטית בעת שינוי

### 2.4 עדכון actions של ניהול הזמנות
**קובץ**: `app/dashboard/(user)/(roles)/admin/bookings/actions.ts`

**שינוי נדרש**:
1. להוסיף פונקציה לעדכון `staticTherapistPay` בהזמנה קיימת
2. לוודא שמעדכנים גם את `companyFee` בהתאם
3. לוודא הרשאות מנהל

## 3. דברים חדשים ליצור

### 3.1 פונקציה לחישוב מחיר מטפל
**קובץ חדש**: `lib/utils/professional-pricing.ts`

**תכולה**:
```typescript
export async function calculateProfessionalPrice(
  professionalId: string | null,
  treatmentId: string,
  durationId?: string
): Promise<number>
```

**תיאור**: פונקציה שמחזירה את המחיר הנכון למטפל (מותאם או בסיס)

### 3.2 רכיב עריכת מחיר במנהל
**קובץ חדש**: `components/admin/bookings/EditTherapistPayment.tsx`

**תכולה**:
- שדה קלט למחיר המטפל
- הצגת המחיר הנוכחי והמחיר המומלץ
- כפתור שמירה עם validation
- עדכון אוטומטי של עמלת החברה

### 3.3 הרחבת ממשק הצגת פרטי הזמנה
**מיקום**: `components/admin/bookings/BookingDetails.tsx` (אם קיים)

**שינוי נדרש**:
- להציג את המחיר המוגדר למטפל
- להציג את עמלת החברה
- להבדיל בין מחיר בסיס למחיר מותאם

### 3.4 עדכון דף פיננסי למטפל
**מיקום**: `app/dashboard/(user)/(roles)/professional/financial/page.tsx`

**שינוי נדרש**:
1. לוודא שהמטפל רואה רק את הסכומים שרלוונטיים לו (`staticTherapistPay`)
2. לא להציג מחירי לקוחות או עמלות משרד
3. להציג בצורה ברורה את מקור התשלום (מחיר בסיס / מחיר מותאם)

### 3.5 הוספת הצגת תשלום למטפל בדף תגובה להזמנה
**קובץ**: `app/dashboard/(user)/(roles)/professional/booking-response/[responseId]/professional-response-client.tsx`

**שינוי נדרש**:
1. להוסיף שדה שמציג למטפל כמה הוא ירוויח מההזמנה
2. להציג רק את הסכום הרלוונטי למטפל (לא מחיר לקוח)
3. להבדיל בין מחיר בסיס למחיר מותאם (אם רלוונטי)

### 3.6 הוספת הצגת תשלום למטפל בדף ניהול הזמנה
**קובץ**: `app/dashboard/(user)/(roles)/professional/booking-management/[bookingId]/page.tsx`

**שינוי נדרש**:
1. להוסיף שדה שמציג למטפל את התשלום שלו מההזמנה
2. להציג את הסכום רק אם המטפל משויך להזמנה
3. להבדיל בין מחיר בסיס למחיר מותאם

### 3.7 עדכון פונקציית קבלת נתוני הזמנה למטפל
**קובץ**: `actions/professional-booking-view-actions.ts`

**שינוי נדרש**:
1. להוסיף את `staticTherapistPay` ל-interface `BookingDetailsForProfessional`
2. לוודא שהמטפל מקבל את המידע הרלוונטי לו בלבד
3. לא לחשוף מחירי לקוח או פרטי תשלום אחרים

### 3.8 עדכון התראות למטפל
**קבצים**: 
- `lib/notifications/templates/sms-templates.ts` (שורות 65-100)
- `lib/notifications/templates/email-templates.ts` (שורות 800-860)
- `lib/notifications/notification-types.ts` (שורות 80-110)

**שינוי נדרש**:
1. להוסיף `professionalPayment` ל-interface `ProfessionalBookingNotificationData`
2. להציג במייל ו-SMS למטפל את הסכום שהוא ירוויח
3. לוודא שלא חושפים מחיר לקוח בהתראות

## 4. ווידוא הפרדה מוחלטת בין לקוחות למטפלים

### 4.1 בדיקת ממשקי לקוח
**מיקומים לבדיקה**:
- `app/(orders)/bookings/` - ממשק הזמנות ללקוח
- `app/dashboard/(user)/(roles)/member/` - דשבורד לקוח

**ווידוא**:
- לקוח לא רואה שום מידע על תשלום למטפל
- מחירים מוצגים בהתאם למה שהלקוח משלם בלבד

### 4.2 בדיקת ממשקי מטפל
**מיקומים לבדיקה**:
- `app/dashboard/(user)/(roles)/professional/` - כל דפי המטפל
- `app/dashboard/(user)/(roles)/professional/booking-management/` - ניהול הזמנות

**ווידוא**:
- מטפל רואה רק את התשלום שלו (`staticTherapistPay + staticTherapistPayExtra`)
- לא רואה מחיר שהלקוח שילם או עמלות

### 4.3 עדכון components משותפים
**מיקומים לבדיקה**:
- `components/` - כל הרכיבים המשותפים
- `types/booking.d.ts` - ודוא שטיפוסים מפרידים נכון

**שינוי נדרש**:
- ליצור טיפוסים נפרדים לתצוגת לקוח ותצוגת מטפל
- לוודא שכל רכיב מקבל רק את הנתונים הרלוונטיים לתפקיד

## 5. טסטים ו-Validation

### 5.1 בדיקות לוגיקה
1. **מחיר בסיס**: ודוא שללא מטפל משוייך, נשמר מחיר בסיס
2. **מחיר מותאם**: ודוא שעם מטפל משוייך עם מחיר מותאם, נשמר המחיר המותאם
3. **עדכון במטפל**: ודוא שכשמשייכים מטפל, המחיר מתעדכן
4. **עריכה ידנית**: ודוא שמנהל יכול לערוך מחיר בהזמנה

### 5.2 בדיקות הפרדה
1. **API endpoints**: ודוא שכל endpoint מחזיר רק נתונים מתאימים לתפקיד
2. **Components**: ודוא שאין חשיפת מידע בין תפקידים
3. **Database queries**: ודוא שלא שולפים מידע לא רלוונטי

## 6. ווידוא סנכרון מושלם בין כל הגורמים

### 6.1 מקומות קריטיים לסנכרון
**חשוב מאוד**: השינויים צריכים להיות סנכרוניים בכל המקומות הבאים:

#### מטפל רואה תשלום בכל המקומות:
1. **התראות SMS/Email** - כשמקבל הזמנה חדשה
2. **דף תגובה להזמנה** - לפני שמאשר/דוחה
3. **דף ניהול הזמנה** - אחרי שמקבל שיוך
4. **דף הפיננסי** - סיכום כל ההזמנות

#### מנהל מעדכן מחירים בכל המקומות:
1. **ניהול מחירי בסיס בטיפולים** - `app/dashboard/(user)/(roles)/admin/treatments/`
2. **ניהול מחירים מותאמים למטפל** - `app/dashboard/(user)/(roles)/admin/professional-management/`
3. **עריכת מחיר בהזמנה ספציפית** - `app/dashboard/(user)/(roles)/admin/bookings/[bookingId]/`
4. **שיוך מטפל להזמנה** - עדכון אוטומטי של המחיר

#### מקומות נוספים שצריכים עדכון:
1. **API routes** - כל ה-endpoints שמחזירים נתוני הזמנות
2. **Professional responses** - דפי התגובות הציבוריים למטפל
3. **Database queries** - וידוא שליפת הנתונים הנכונים
4. **Email/SMS templates** - הצגת המחיר הנכון

### 6.2 לוגיקת הסנכרון
#### סדר פעולות שחייב להיות עקבי:
1. **יצירת הזמנה**: מחיר בסיס → staticTherapistPay
2. **שיוך מטפל**: בדיקת מחיר מותאם → עדכון staticTherapistPay
3. **עריכת מנהל**: עדכון ידני → עדכון staticTherapistPay
4. **עדכון מחירי בסיס**: אוטומטית לכל ההזמנות הבאות
5. **עדכון מחירים מותאמים**: אוטומטית רק להזמנות חדשות

### 6.3 נקודות כשל אפשריות
#### מקומות שעלולים לגרום לחוסר סנכרון:
1. **Cache** - אם יש מטמון של מחירים ולא מתעדכן
2. **Database transactions** - אם עדכון נכשל באמצע
3. **Background jobs** - אם יש עדכונים אסינכרוניים
4. **API timeouts** - אם חלק מהעדכונים נכשלים

## 7. סדר ביצוע מומלץ (מעודכן)

1. **שלב 1**: ליצור את `lib/utils/professional-pricing.ts`
2. **שלב 2**: לעדכן את לוגיקת חישוב ב-`actions/booking-actions.ts`
3. **שלב 3**: לעדכן פונקציית שיוך מטפל עם לוגיקת מחיר חדשה
4. **שלב 4**: לעדכן את `actions/professional-booking-view-actions.ts`
5. **שלב 5**: לעדכן את התראות למטפל (SMS/Email)
6. **שלב 6**: לעדכן ממשקי המטפל (תגובה + ניהול הזמנה)
7. **שלב 7**: ליצור רכיב עריכת מחיר למנהל
8. **שלב 8**: לעדכן כל ה-API routes הרלוונטיים
9. **שלב 9**: טסטים מקיפים לכל התהליך
10. **שלב 10**: בדיקות סנכרון בין כל הגורמים

## 8. עדכון API Routes הרלוונטיים

### 8.1 API endpoints שצריכים לכלול מחירי מטפל
**חשוב**: כל ה-endpoints הבאים צריכים להחזיר את `staticTherapistPay` למטפלים:

1. **`/api/professional/response/[responseId]/route.ts`** - פרטי הזמנה לתגובה
2. **`/api/professional/bookings/route.ts`** - רשימת הזמנות למטפל  
3. **`/api/professional/booking/[bookingId]/route.ts`** - פרטי הזמנה ספציפית
4. **`/api/admin/bookings/[bookingId]/assign/route.ts`** - עדכון מחיר בשיוך
5. **`/api/admin/bookings/by-professional/[professionalId]/route.ts`** - הזמנות למטפל ספציפי

### 8.2 API endpoints שצריכים עדכון לוגיקה
1. **`/api/admin/professional-management/[id]/treatments/route.ts`** - עדכון מחירים מותאמים
2. **`/api/admin/treatments/route.ts`** - עדכון מחירי בסיס
3. **`/api/admin/bookings/[bookingId]/update-therapist-pay/route.ts`** - נדרש ליצור חדש

### 8.3 API endpoints שצריכים הפרדה טובה יותר
1. **למטפלים** - רק `staticTherapistPay`, לא מחירי לקוח
2. **ללקוחות** - רק מחירי לקוח, לא תשלומי מטפל
3. **למנהלים** - הכל

## 9. שיקולים נוספים

### 9.1 Backward Compatibility
- לוודא שהזמנות קיימות ממשיכות לעבוד
- לטפל בהזמנות שאין להן `staticTherapistPay`

### 9.2 Performance
- הפונקציה החדשה לחישוב מחיר לא צריכה להאט יצירת הזמנות
- לשקול cache למחירי מטפלים נפוצים

### 9.3 Logs ו-Audit
- לתעד כל שינוי במחיר המטפל (מי שינה, מתי, מה היה המחיר הקודם)
- לאפשר למנהל לראות היסטוריית שינויים

### 9.4 מעקב אחר שינויים
- ליצור לוג של כל עדכון מחיר (בסיס ומותאם)
- לוודא שכל שינוי מתועד עם timestamp ו-user ID
- לאפשר rollback במקרה של שגיאה

## 10. סיכום מקומות שהמטפל רואה/יראה תשלומים

### 10.1 מצב קיים - היכן המטפל רואה כסף כרגע:
1. **דף פיננסי בלבד** - `app/dashboard/(user)/(roles)/professional/financial/page.tsx`
   - רואה `staticTherapistPay + staticTherapistPayExtra` מהזמנות שהושלמו
   - לא רואה מחירי לקוח או עמלות

### 10.2 מצב עתידי - היכן המטפל יראה כסף אחרי השדרוג:
1. **התראות SMS/Email** - כשמקבל הזמנה חדשה
   - יראה כמה הוא ירוויח מההזמנה
   - רק הסכום המגיע לו, לא מחיר הלקוח

2. **דף תגובה להזמנה** - `app/dashboard/(user)/(roles)/professional/booking-response/[responseId]/`
   - יראה את התשלום שלו לפני שמחליט לקבל/דחות
   - יבדיל בין מחיר בסיס למחיר מותאם (אם רלוונטי)

3. **דף ניהול הזמנה** - `app/dashboard/(user)/(roles)/professional/booking-management/[bookingId]/`
   - יראה את התשלום שלו לאחר קבלת ההזמנה
   - יוכל לעקוב אחר הסטטוס וההכנסה

4. **דף פיננסי מורחב** - `app/dashboard/(user)/(roles)/professional/financial/`
   - סיכום מפורט יותר עם הבחנה בין מחירי בסיס ומותאמים
   - היסטוריית תשלומים עם פירוט מקור המחיר

### 10.3 עקרונות הפרדה שיישמרו:
- ✅ מטפל רואה רק את התשלום שלו (`staticTherapistPay`)
- ✅ מטפל לא רואה מחיר שהלקוח שילם
- ✅ מטפל לא רואה עמלות משרד או רווחי חברה
- ✅ לקוח לא רואה תשלומי מטפל
- ✅ רק מנהל רואה את התמונה המלאה

---

**הערה**: תוכנית זו מבוססת על ניתוח מלא של הקבצים הקיימים במערכת ומבטיחה שמירה על כל הפונקציונליות הקיימת תוך הוספת היכולות החדשות הנדרשות ושמירה על הפרדה מוחלטת בין תפקידים.