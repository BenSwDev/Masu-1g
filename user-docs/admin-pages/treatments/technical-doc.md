# תהליך ניהול הטיפולים

מסך הטיפולים מורכב ממספר שלבים ותהליכים הפועלים מאחורי הקלעים.

## תהליך טעינת הדף
1. עם טעינת העמוד מופעלת `requireUserSession` כדי לוודא שהמשתמש מחובר ובעל הרשאת מנהל. ההגדרה `export const dynamic = 'force-dynamic'` מונעת חיבור למסד הנתונים בשלב הבניה.
2. הקומפוננטה `TreatmentStatsCards` מפעילה את הפעולה `getTreatmentStats` המחשבת במסד הנתונים את כל הסטטיסטיקות הנדרשות. התוצאה מוצגת בכרטיסי סטטיסטיקה או הודעת שגיאה במקרה הצורך.

## ניהול נתונים וסטטיסטיקות
הפונקציה `getTreatmentStats` מחשבת:
- סך הטיפולים והטיפולים הפעילים/לא פעילים
- חלוקה לקטגוריות (עיסויים, טיפולי פנים, אחר)
- סוגי תמחור (מחיר קבוע, לפי משך)
- מחיר ממוצע וטווח מחירים
- כמות הטיפולים שנוספו ב־30 הימים האחרונים

## ניהול רשימת הטיפולים
3. הרכיב `TreatmentsClient` טוען את רשימת הטיפולים באמצעות React Query. הפונקציה `getAllTreatments` מקבלת מסננים כגון חיפוש, קטגוריה, סוג תמחור וסטטוס, ומחזירה תוצאות עם עמודים ומידע על המשך.
4. מערכת המיון מאפשרת מיון לפי שם, מחיר, משך זמן או תאריך יצירה.
5. מערכת הפאגינציה מחלקת את התוצאות לעמודים עם ניווט בין עמודים.

## פעולות CRUD
6. דיאלוג "הוסף טיפול" משתמש בפעולה `createTreatment`. לפני השמירה מתבצעת ולידציה בזוד ובמסד הנתונים לוודא שמות ייחודיים וערכים תקינים. בסיום הפעולה קוראים ל־`revalidatePath` כדי לרענן את הדף.
7. עריכת טיפול מתבצעת דרך `updateTreatment` הפועלת באותה צורה ומחזירה את הטיפול המעודכן. גם כאן מתבצעות בדיקות לשדות חובה ולשינוי שם קיים.
8. לחיצה על "הפעל" או "השבת" מפעילה את `toggleTreatmentStatus` המעבירה את הטיפול ממצב פעיל ללא פעיל ולהפך.
9. פעולות מחיקה (`deleteTreatment`) ושכפול (`duplicateTreatment`) מחזירות הודעת הצלחה או שגיאה ומבצעות `revalidatePath`.

## ולידציה ואימות
10. מודל הנתונים `lib/db/models/treatment.ts` מגדיר את מבנה הטיפול במונגו־די־בי ומכיל hook שמוודא התאמה בין סוג התמחור לשדות שנשלחו. לדוגמה, טיפולים במחיר קבוע חייבים מחיר ומשך ברירת מחדל, וטיפולים לפי משך דורשים לפחות משך אחד.
11. כל פעולה עוברת דרך `requireAdminAuth` המוודא שהמשתמש מחובר ובעל הרשאת מנהל.

## ניהול מצב ומשוב
12. React Query מנהל את מצב הנתונים, כולל קאשינג, רענון אוטומטי ומצבי טעינה.
13. בסיום כל פעולה מתבצע רענון של הנתונים בעזרת `refetch` מצד הלקוח כך שהעמוד מציג תמיד את המצב העדכני.
14. מערכת ה־toast notifications מציגה הודעות הצלחה או שגיאה למשתמש.

כאשר מתרחשת שגיאה בתקשורת או בולידציה, מוצגת הודעת שגיאה מתאימה והפעולה אינה נשמרת.
