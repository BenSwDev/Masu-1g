# תהליך ניהול הערים

מסך הערים מטפל ברשימת הערים הפעילות ובפרטי המיקום שלהן.

## תהליך טעינת הדף
1. הקריאה הראשונית מתבצעת בשרת בעזרת `requireUserSession` כדי לוודא הרשאות מנהל.
2. פונקציית `getCities` מחזירה את העמוד והחיפוש המבוקש וממירה אובייקטי Mongoose לאובייקטי נתונים קלים.
3. הערכים מוחזרים לרכיב `CityManagement` כ־props ומוצגים בטבלה.

## ניהול נתונים וסטטיסטיקות
- מודל `City` שומר שם, קורדינטות וסטטוס פעילות של כל עיר.
- מודל `CityDistance` מחשב ושומר מרחקים בין כל זוג ערים ומספק שיטות עזר למציאת ערים במרחק נתון.
- כאשר עיר חדשה נוצרת, מופעלת `calculateDistancesForNewCity` כדי לעדכן את טבלת המרחקים לכל הערים הקיימות.

## ניהול רשימת הערים
- רכיב `CityManagement` מציג שדה חיפוש, טבלה ודיאלוג הוספת עיר.
- הפונקציה `loadCities` מבצעת קריאות חוזרות ל־`getCities` בהתאם לחיפוש ולפאגינציה.
- הטבלה מציגה שם, קורדינטות וסטטוס פעיל של כל עיר.

## פעולות CRUD
- **Create**: `createCity` מקבל נתוני טופס, מאמת ערכים ויוצר עיר חדשה. לאחר השמירה מתבצע חישוב מרחקים ועדכון מטמון.
- **Update**: `updateCity` מעדכן פרטי עיר קיימת, כולל בדיקות ייחודיות ושינוי סטטוס. שינוי קורדינטות מוביל לחישוב מרחקים מחדש.
- **Delete**: `deleteCity` מוחק עיר ואת רשומות המרחקים שלה (עדיין ללא בדיקה אם העיר בשימוש בהזמנות).
- **Toggle Status**: `toggleCityStatus` מחליף את ערך `isActive` ושומר את העיר.

## ולידציה ואימות
- בשלב צד הלקוח מתבצעת בדיקה בסיסית לשדות נדרשים ולטווח קורדינטות.
- בסביבת השרת, מודל `City` משתמש ב־Mongoose לאימות הסכימה.
- קובץ `city-validation.ts` מספק סכמת Zod לבדיקה מול רשימת ערים פעילות עם מטמון לזירוז הבדיקות.

## ניהול מצב ומשוב
- `CityManagement` ו־`CityFormDialog` מציגים מצבי טעינה, תיבות Toast להודעות הצלחה או שגיאה ופאגינציה על פי כמות הדפים.
- קריאות לשינוי נתונים מבצעות `revalidatePath` על מנת לרענן את הדף לאחר הפעולה.
