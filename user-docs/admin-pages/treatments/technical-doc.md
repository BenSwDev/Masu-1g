# תהליך ניהול הטיפולים

מסך הטיפולים מורכב ממספר שלבים ותהליכים הפועלים מאחורי הקלעים.

1. עם טעינת העמוד מופעלת `requireUserSession` כדי לוודא שהמשתמש מחובר ובעל הרשאת מנהל. ההגדרה `export const dynamic = 'force-dynamic'` מונעת חיבור למסד הנתונים בשלב הבניה.
2. הקומפוננטה `TreatmentStatsCards` מפעילה את הפעולה `getTreatmentStats` המחשבת במסד הנתונים את סך הטיפולים, סטטוס הפעילות, חלוקה לקטגוריות, סוגי תמחור וטווחי מחיר. התוצאה מוצגת בכרטיסי סטטיסטיקה או הודעת שגיאה במקרה הצורך.
3. הרכיב `TreatmentsClient` טוען את רשימת הטיפולים באמצעות React Query. הפונקציה `getAllTreatments` מקבלת מסננים כגון חיפוש, קטגוריה, סוג תמחור וסטטוס, ומחזירה תוצאות עם עמודים ומידע על המשך.
4. דיאלוג "הוסף טיפול" משתמש בפעולה `createTreatment`. לפני השמירה מתבצעת ולידציה בזוד ובמסד הנתונים לוודא שמות ייחודיים וערכים תקינים. בסיום הפעולה קוראים ל־`revalidatePath` כדי לרענן את הדף.
5. עריכת טיפול מתבצעת דרך `updateTreatment` הפועלת באותה צורה ומחזירה את הטיפול המעודכן. גם כאן מתבצעות בדיקות לשדות חובה ולשינוי שם קיים.
6. לחיצה על "הפעל" או "השבת" מפעילה את `toggleTreatmentStatus` המעבירה את הטיפול ממצב פעיל ללא פעיל ולהפך. פעולה זו וגם פעולות מחיקה (`deleteTreatment`) ושכפול (`duplicateTreatment`) מחזירות הודעת הצלחה או שגיאה ומבצעות `revalidatePath`.
7. מודל הנתונים `lib/db/models/treatment.ts` מגדיר את מבנה הטיפול במונגו־די־בי ומכיל hook שמוודא התאמה בין סוג התמחור לשדות שנשלחו. לדוגמה, טיפולים במחיר קבוע חייבים מחיר ומשך ברירת מחדל, וטיפולים לפי משך דורשים לפחות משך אחד.
8. בסיום כל פעולה מתבצע רענון של הנתונים בעזרת `refetch` מצד הלקוח כך שהעמוד מציג תמיד את המצב העדכני.

כאשר מתרחשת שגיאה בתקשורת או בולידציה, מוצגת הודעת שגיאה מתאימה והפעולה אינה נשמרת.
