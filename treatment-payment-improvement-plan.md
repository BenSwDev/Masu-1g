# תוכנית עבודה: שיפור מערכת תשלום למטפלים

## 1. מצב קיים במערכת

### מבנה נתונים קיים
- **מודל Treatment**: כולל `fixedProfessionalPrice` (טיפולים קבועים) ו-`professionalPrice` בכל `duration` (טיפולים משתנים)
- **מודל ProfessionalProfile**: כולל מערך `treatments: ITreatmentPricing[]` שמאפשר מחירים מותאמים למטפל
- **מודל Booking**: כולל `staticTherapistPay` שמקבע את התשלום למטפל בהזמנה

### לוגיקה נוכחית 
- ב-`actions/booking-actions.ts` (שורות 2550-2580, 2740-2780): המערכת תמיד מגדירה את `staticTherapistPay` לפי מחירי הבסיס של הטיפול
- לא מתחשבת במחירים המותאמים המוגדרים ב-`ITreatmentPricing` של המטפל
- המחיר נקבע פעם אחת בעת יצירת ההזמנה ולא מתעדכן כשמשייכים מטפל

### ממשקי משתמש קיימים
- **מנהל**: `app/dashboard/(user)/(roles)/admin/professional-management/` - ניהול מחירי מטפלים
- **מטפל**: `app/dashboard/(user)/(roles)/professional/financial/` - צפייה בסיכום פיננסי
- **הזמנות**: `app/dashboard/(user)/(roles)/admin/bookings/` - ניהול הזמנות

## 2. שינויים נדרשים לדברים קיימים

### 2.1 עדכון לוגיקת חישוב מחיר במטפל
**קובץ**: `actions/booking-actions.ts`

**מיקום**: פונקציות שמגדירות `staticTherapistPay` (שורות ~2558, ~2751)

**שינוי נדרש**: 
1. לפני שימוש במחיר הבסיס של הטיפול, לבדוק אם יש מטפל משוייך להזמנה
2. אם יש מטפל משוייך, לחפש ב-`ProfessionalProfile.treatments` מחיר מותאם
3. אם נמצא מחיר מותאם - להשתמש בו
4. אם לא נמצא מחיר מותאם - להשתמש במחיר הבסיס של הטיפול

### 2.2 עדכון לוגיקת שיוך מטפל להזמנה
**קובץ**: `actions/booking-actions.ts`

**מיקום**: פונקציה `assignProfessionalToBooking` (שורה ~2271)

**שינוי נדרש**:
1. לאחר שיוך המטפל, לעדכן את `staticTherapistPay` לפי המחיר המותאם למטפל (אם קיים)
2. לעדכן את `companyFee` בהתאם
3. לוודא שהעדכון נשמר בבסיס הנתונים

### 2.3 עדכון ממשק ניהול הזמנות למנהל
**קובץ**: `app/dashboard/(user)/(roles)/admin/bookings/[bookingId]/page.tsx`

**שינוי נדרש**:
1. להוסיף שדה עריכה של `staticTherapistPay` בממשק
2. לוודא שהשדה זמין לעריכה גם כשיש מטפל משוייך וגם כשאין
3. לעדכן את `companyFee` אוטומטית בעת שינוי

### 2.4 עדכון actions של ניהול הזמנות
**קובץ**: `app/dashboard/(user)/(roles)/admin/bookings/actions.ts`

**שינוי נדרש**:
1. להוסיף פונקציה לעדכון `staticTherapistPay` בהזמנה קיימת
2. לוודא שמעדכנים גם את `companyFee` בהתאם
3. לוודא הרשאות מנהל

## 3. דברים חדשים ליצור

### 3.1 פונקציה לחישוב מחיר מטפל
**קובץ חדש**: `lib/utils/professional-pricing.ts`

**תכולה**:
```typescript
export async function calculateProfessionalPrice(
  professionalId: string | null,
  treatmentId: string,
  durationId?: string
): Promise<number>
```

**תיאור**: פונקציה שמחזירה את המחיר הנכון למטפל (מותאם או בסיס)

### 3.2 רכיב עריכת מחיר במנהל
**קובץ חדש**: `components/admin/bookings/EditTherapistPayment.tsx`

**תכולה**:
- שדה קלט למחיר המטפל
- הצגת המחיר הנוכחי והמחיר המומלץ
- כפתור שמירה עם validation
- עדכון אוטומטי של עמלת החברה

### 3.3 הרחבת ממשק הצגת פרטי הזמנה
**מיקום**: `components/admin/bookings/BookingDetails.tsx` (אם קיים)

**שינוי נדרש**:
- להציג את המחיר המוגדר למטפל
- להציג את עמלת החברה
- להבדיל בין מחיר בסיס למחיר מותאם

### 3.4 עדכון דף פיננסי למטפל
**מיקום**: `app/dashboard/(user)/(roles)/professional/financial/page.tsx`

**שינוי נדרש**:
1. לוודא שהמטפל רואה רק את הסכומים שרלוונטיים לו (`staticTherapistPay`)
2. לא להציג מחירי לקוחות או עמלות משרד
3. להציג בצורה ברורה את מקור התשלום (מחיר בסיס / מחיר מותאם)

## 4. ווידוא הפרדה מוחלטת בין לקוחות למטפלים

### 4.1 בדיקת ממשקי לקוח
**מיקומים לבדיקה**:
- `app/(orders)/bookings/` - ממשק הזמנות ללקוח
- `app/dashboard/(user)/(roles)/member/` - דשבורד לקוח

**ווידוא**:
- לקוח לא רואה שום מידע על תשלום למטפל
- מחירים מוצגים בהתאם למה שהלקוח משלם בלבד

### 4.2 בדיקת ממשקי מטפל
**מיקומים לבדיקה**:
- `app/dashboard/(user)/(roles)/professional/` - כל דפי המטפל
- `app/dashboard/(user)/(roles)/professional/booking-management/` - ניהול הזמנות

**ווידוא**:
- מטפל רואה רק את התשלום שלו (`staticTherapistPay + staticTherapistPayExtra`)
- לא רואה מחיר שהלקוח שילם או עמלות

### 4.3 עדכון components משותפים
**מיקומים לבדיקה**:
- `components/` - כל הרכיבים המשותפים
- `types/booking.d.ts` - ודוא שטיפוסים מפרידים נכון

**שינוי נדרש**:
- ליצור טיפוסים נפרדים לתצוגת לקוח ותצוגת מטפל
- לוודא שכל רכיב מקבל רק את הנתונים הרלוונטיים לתפקיד

## 5. טסטים ו-Validation

### 5.1 בדיקות לוגיקה
1. **מחיר בסיס**: ודוא שללא מטפל משוייך, נשמר מחיר בסיס
2. **מחיר מותאם**: ודוא שעם מטפל משוייך עם מחיר מותאם, נשמר המחיר המותאם
3. **עדכון במטפל**: ודוא שכשמשייכים מטפל, המחיר מתעדכן
4. **עריכה ידנית**: ודוא שמנהל יכול לערוך מחיר בהזמנה

### 5.2 בדיקות הפרדה
1. **API endpoints**: ודוא שכל endpoint מחזיר רק נתונים מתאימים לתפקיד
2. **Components**: ודוא שאין חשיפת מידע בין תפקידים
3. **Database queries**: ודוא שלא שולפים מידע לא רלוונטי

## 6. סדר ביצוע מומלץ

1. **שלב 1**: ליצור את `lib/utils/professional-pricing.ts`
2. **שלב 2**: לעדכן את לוגיקת חישוב ב-`actions/booking-actions.ts`
3. **שלב 3**: לעדכן פונקציית שיוך מטפל
4. **שלב 4**: ליצור רכיב עריכת מחיר למנהל
5. **שלב 5**: לעדכן ממשקי תצוגה
6. **שלב 6**: לבצע בדיקות הפרדה ו-validation
7. **שלב 7**: טסטים מקיפים

## 7. שיקולים נוספים

### 7.1 Backward Compatibility
- לוודא שהזמנות קיימות ממשיכות לעבוד
- לטפל בהזמנות שאין להן `staticTherapistPay`

### 7.2 Performance
- הפונקציה החדשה לחישוב מחיר לא צריכה להאט יצירת הזמנות
- לשקול cache למחירי מטפלים נפוצים

### 7.3 Logs ו-Audit
- לתעד כל שינוי במחיר המטפל (מי שינה, מתי, מה היה המחיר הקודם)
- לאפשר למנהל לראות היסטוריית שינויים

---

**הערה**: תוכנית זו מבוססת על ניתוח מלא של הקבצים הקיימים במערכת ומבטיחה שמירה על כל הפונקציונליות הקיימת תוך הוספת היכולות החדשות הנדרשות.